<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>„Å≤„Çâ„Åå„Å™ Hiragana Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body {height:100%}
    input[type="range"] { width: 140px; }
    .btn{@apply px-3 py-2 rounded-xl text-sm border border-gray-300 bg-white hover:bg-gray-50 transition}
    .btn-ghost{@apply px-3 py-2 rounded-xl text-sm bg-transparent hover:bg-white/30 border-transparent}
    .btn-primary{@apply px-4 py-2 rounded-xl bg-black text-white hover:opacity-90 transition}
    .chip{@apply inline-flex items-center gap-2 px-2.5 py-1.5 rounded-full text-xs bg-white/70 backdrop-blur border border-white/50}
    .card{@apply bg-white/80 backdrop-blur rounded-2xl shadow p-4 sm:p-6 border border-white}
    .metric{@apply px-3 py-2 rounded-xl bg-white/90 backdrop-blur shadow text-right border border-white}
    .glass{@apply bg-white/50 backdrop-blur border border-white}
  </style>
</head>
<body class="min-h-screen text-gray-900 bg-gradient-to-br from-sky-50 via-indigo-50 to-rose-50">
  <div class="mx-auto w-full max-w-5xl p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-4">
      <div class="flex items-center gap-3">
        <div class="chip">
          <span class="text-lg">üáØüáµ</span><span class="font-semibold">Hiragana Trainer</span>
        </div>
        <span class="hidden sm:inline text-xs text-gray-500">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ+‡∏ù‡∏∂‡∏Å‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Æ‡∏¥‡∏£‡∏≤‡∏á‡∏≤‡∏ô‡∏∞</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="metric">
          <div class="text-xs text-gray-500">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
          <div id="score" class="text-lg font-semibold leading-tight">0/0</div>
          <div id="acc" class="text-[10px] text-gray-400">0%</div>
        </div>
        <div class="metric">
          <div class="text-xs text-gray-500">‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ</div>
          <div id="streak" class="text-lg font-semibold leading-tight">0</div>
        </div>
        <button id="resetBtn" class="btn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>
    </header>

    <div class="grid lg:grid-cols-[1fr,320px] gap-4">
      <section class="card">
        <div class="flex flex-wrap items-center gap-2">
          <div class="inline-flex rounded-2xl border bg-white/70 backdrop-blur overflow-hidden">
            <button data-tab="multiple" class="tab px-3 py-2 text-sm bg-black text-white">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            <button data-tab="typing"   class="tab px-3 py-2 text-sm">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
            <button data-tab="cards"    class="tab px-3 py-2 text-sm">Flashcards</button>
          </div>
          <div class="flex items-center gap-2 ml-auto">
            <label class="chip">
              <input id="autoplay" type="checkbox" class="accent-black">
              <span>‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
            </label>
            <button id="speakBtn" class="btn" title="‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏Å‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î)">üîä ‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
          </div>
        </div>

        <div class="mt-3 grid sm:grid-cols-2 gap-2 glass rounded-xl p-3">
          <div class="flex flex-wrap items-center gap-3">
            <span class="text-xs text-gray-600">Voice</span>
            <label class="chip">
              <span class="opacity-70 text-xs">Speed</span>
              <input id="rate" type="range" min="0.6" max="1.4" step="0.05" value="1" />
              <span id="rateVal" class="text-xs w-8 text-right">1.00</span>
            </label>
            <label class="chip">
              <span class="opacity-70 text-xs">Volume</span>
              <input id="voiceVol" type="range" min="0" max="1" step="0.05" value="1" />
              <span id="voiceVolVal" class="text-xs w-8 text-right">1.00</span>
            </label>
            <button id="voiceTest" class="btn-ghost" title="‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î">‡∏•‡∏≠‡∏á‡∏û‡∏π‡∏î„Äå„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Äç</button>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <span class="text-xs text-gray-600">BGM</span>
            <button id="bgmToggle" class="btn">üéµ BGM: Off</button>
            <label class="chip">
              <span class="opacity-70 text-xs">Volume</span>
              <input id="bgmVol" type="range" min="0" max="1" step="0.05" value="0.15" />
              <span id="bgmVolVal" class="text-xs w-8 text-right">0.15</span>
            </label>
            <label class="chip cursor-pointer" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á (mp3/ogg)">
              <input id="bgmFile" type="file" accept="audio/*" class="hidden" />
              <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î BGM</span>
            </label>
          </div>
        </div>

        <div id="qwrap" class="mt-4 flex flex-col items-center"></div>
      </section>

      <aside class="card">
        <div class="font-semibold mb-2">‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏±‡∏ô)</div>
        <div id="rowList" class="grid grid-cols-2 gap-2 text-sm"></div>

        <div class="mt-4 flex gap-2">
          <button id="selectAll" class="btn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button id="selectEasy" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡πà‡∏≤‡∏¢ („ÅÇ~„Åï)</button>
        </div>

        <div class="mt-6">
          <div class="font-semibold mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <ul id="history" class="space-y-1 max-h-64 overflow-auto pr-1 text-sm"></ul>
        </div>

        <details class="mt-6">
          <summary class="cursor-pointer font-semibold">Self-tests <span id="tstatus" class="text-xs opacity-70">(not run)</span></summary>
          <div class="mt-2 flex items-center gap-2">
            <button id="runTests" class="btn">Run tests</button>
            <span id="tlabel" class="text-sm text-gray-600"></span>
          </div>
          <ul id="tresults" class="mt-2 space-y-1 text-sm"></ul>
        </details>

        <div class="mt-4 text-xs text-gray-500">
          ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: „Åó = shi/si, „Å° = chi/ti, „Å§ = tsu/tu, „Åµ = fu/hu, „Çí = wo/o, „Çì = n/nn/n'
        </div>
      </aside>
    </div>

    <footer class="mt-4 text-xs text-gray-500 text-center">
      ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏à‡∏Å‡πà‡∏≠‡∏ô 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥), ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î üîä ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î BGM
    </footer>
  </div>

  <!-- Default BGM set to your Pixabay track (will still require user click to start) -->
  <audio id="bgm" loop preload="auto" class="hidden"
    src="https://cdn.pixabay.com/download/audio/2023/03/28/audio_43dd1537e4.mp3?filename=japanese-style-piano%E7%8E%89%E9%9F%BF-257200.mp3">
  </audio>

  <script>
    // ---------------- Data ----------------
    const KANA = [
      { kana: '„ÅÇ', romaji: ['a'], row: 'a' },
      { kana: '„ÅÑ', romaji: ['i'], row: 'a' },
      { kana: '„ÅÜ', romaji: ['u'], row: 'a' },
      { kana: '„Åà', romaji: ['e'], row: 'a' },
      { kana: '„Åä', romaji: ['o'], row: 'a' },
      { kana: '„Åã', romaji: ['ka'], row: 'ka' },
      { kana: '„Åç', romaji: ['ki'], row: 'ka' },
      { kana: '„Åè', romaji: ['ku'], row: 'ka' },
      { kana: '„Åë', romaji: ['ke'], row: 'ka' },
      { kana: '„Åì', romaji: ['ko'], row: 'ka' },
      { kana: '„Åï', romaji: ['sa'], row: 'sa' },
      { kana: '„Åó', romaji: ['shi','si'], row: 'sa' },
      { kana: '„Åô', romaji: ['su'], row: 'sa' },
      { kana: '„Åõ', romaji: ['se'], row: 'sa' },
      { kana: '„Åù', romaji: ['so'], row: 'sa' },
      { kana: '„Åü', romaji: ['ta'], row: 'ta' },
      { kana: '„Å°', romaji: ['chi','ti'], row: 'ta' },
      { kana: '„Å§', romaji: ['tsu','tu'], row: 'ta' },
      { kana: '„Å¶', romaji: ['te'], row: 'ta' },
      { kana: '„Å®', romaji: ['to'], row: 'ta' },
      { kana: '„Å™', romaji: ['na'], row: 'na' },
      { kana: '„Å´', romaji: ['ni'], row: 'na' },
      { kana: '„Å¨', romaji: ['nu'], row: 'na' },
      { kana: '„Å≠', romaji: ['ne'], row: 'na' },
      { kana: '„ÅÆ', romaji: ['no'], row: 'na' },
      { kana: '„ÅØ', romaji: ['ha'], row: 'ha' },
      { kana: '„Å≤', romaji: ['hi'], row: 'ha' },
      { kana: '„Åµ', romaji: ['fu','hu'], row: 'ha' },
      { kana: '„Å∏', romaji: ['he'], row: 'ha' },
      { kana: '„Åª', romaji: ['ho'], row: 'ha' },
      { kana: '„Åæ', romaji: ['ma'], row: 'ma' },
      { kana: '„Åø', romaji: ['mi'], row: 'ma' },
      { kana: '„ÇÄ', romaji: ['mu'], row: 'ma' },
      { kana: '„ÇÅ', romaji: ['me'], row: 'ma' },
      { kana: '„ÇÇ', romaji: ['mo'], row: 'ma' },
      { kana: '„ÇÑ', romaji: ['ya'], row: 'ya' },
      { kana: '„ÇÜ', romaji: ['yu'], row: 'ya' },
      { kana: '„Çà', romaji: ['yo'], row: 'ya' },
      { kana: '„Çâ', romaji: ['ra'], row: 'ra' },
      { kana: '„Çä', romaji: ['ri'], row: 'ra' },
      { kana: '„Çã', romaji: ['ru'], row: 'ra' },
      { kana: '„Çå', romaji: ['re'], row: 'ra' },
      { kana: '„Çç', romaji: ['ro'], row: 'ra' },
      { kana: '„Çè', romaji: ['wa'], row: 'wa' },
      { kana: '„Çí', romaji: ['wo','o'], row: 'wa' },
      { kana: '„Çì', romaji: ['n','nn',"n'"], row: 'n' },
    ];
    const ROWS = [
      { key:'a', label:'„ÅÇ(„ÅÇ-„Åä)' },
      { key:'ka', label:'„Åã(„Åã-„Åì)' },
      { key:'sa', label:'„Åï(„Åï-„Åù)' },
      { key:'ta', label:'„Åü(„Åü-„Å®)' },
      { key:'na', label:'„Å™(‡∏ô-„ÅÆ)' },
      { key:'ha', label:'„ÅØ(„ÅØ-„Åª)' },
      { key:'ma', label:'„Åæ(„Åæ-„ÇÇ)' },
      { key:'ya', label:'„ÇÑ(‡∏¢-„Çà)' },
      { key:'ra', label:'„Çâ(„Çâ-„Çç)' },
      { key:'wa', label:'„Çè/„Çí' },
      { key:'n', label:'„Çì' },
    ];

    const $ = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
    const pick = (a)=>a[Math.floor(Math.random()*a.length)];
    const shuffle = (a)=>[...a].sort(()=>Math.random()-0.5);
    const norm = (s)=>(s??'').trim().toLowerCase().replace(/\s+/g,'');
    const isCorrect=(input,item)=>item.romaji.some(r=>norm(r)===norm(input));

    // Speech
    let voiceJA=null;
    let rate=parseFloat(localStorage.getItem('rate')??'1')||1;
    let voiceVol=parseFloat(localStorage.getItem('voiceVol')??'1')||1;
    function chooseJapaneseVoice(){
      const v=window.speechSynthesis?.getVoices?.()||[];
      voiceJA = v.find(x=>x.lang?.toLowerCase()==='ja-jp')||v.find(x=>x.lang?.toLowerCase().startsWith('ja'))||null;
    }
    if('speechSynthesis'in window){chooseJapaneseVoice();window.speechSynthesis.onvoiceschanged=chooseJapaneseVoice;}
    function speakJa(text){
      if(!('speechSynthesis'in window)){alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (Web Speech API)');return;}
      try{window.speechSynthesis.cancel();}catch{}
      const u=new SpeechSynthesisUtterance(text);
      u.lang='ja-JP'; if(voiceJA) u.voice=voiceJA; u.rate=rate; u.pitch=1; u.volume=voiceVol;
      window.speechSynthesis.speak(u);
    }

    // BGM
    const bgm=$('#bgm');
    let bgmOn=localStorage.getItem('bgmOn')==='true';
    let bgmVol=parseFloat(localStorage.getItem('bgmVol')??'0.15')||0.15;
    bgm.volume=bgmVol;
    async function setBgmOn(on){
      bgmOn=on; localStorage.setItem('bgmOn',String(on));
      $('#bgmToggle').textContent=on?'üéµ BGM: On':'üéµ BGM: Off';
      if(on){try{await bgm.play();}catch{}} else {try{bgm.pause();}catch{}}
    }

    // State
    let mode='multiple';
    let enabledRows=new Set(JSON.parse(localStorage.getItem('enabledRows')||'[]'));
    if(enabledRows.size===0) enabledRows=new Set(ROWS.map(r=>r.key));
    let pool=KANA.filter(k=>enabledRows.has(k.row));
    let question=null; let choices=[]; let reveal=false;
    let score=parseInt(localStorage.getItem('score')||'0',10);
    let total=parseInt(localStorage.getItem('total')||'0',10);
    let streak=parseInt(localStorage.getItem('streak')||'0',10);
    let history=JSON.parse(localStorage.getItem('history')||'[]');

    // UI
    $$('.tab').forEach(b=>{
      b.addEventListener('click',()=>{
        $$('.tab').forEach(x=>x.classList.remove('bg-black','text-white'));
        b.classList.add('bg-black','text-white');
        mode=b.dataset.tab; render(); newQuestion();
      });
    });

    $('#resetBtn').addEventListener('click',()=>{score=0;total=0;streak=0;history=[];persist();updateMetrics();renderHistory();});
    $('#selectAll').addEventListener('click',()=>{enabledRows=new Set(ROWS.map(r=>r.key));persistRows();rebuildRowsUI();rebuildPool();newQuestion();});
    $('#selectEasy').addEventListener('click',()=>{enabledRows=new Set(['a','ka','sa']);persistRows();rebuildRowsUI();rebuildPool();newQuestion();});

    // Voice sliders
    $('#rate').value=rate.toFixed(2); $('#rateVal').textContent=rate.toFixed(2);
    $('#rate').addEventListener('input',e=>{rate=parseFloat(e.target.value);$('#rateVal').textContent=rate.toFixed(2);localStorage.setItem('rate',String(rate));});
    $('#voiceVol').value=voiceVol.toFixed(2); $('#voiceVolVal').textContent=voiceVol.toFixed(2);
    $('#voiceVol').addEventListener('input',e=>{voiceVol=parseFloat(e.target.value);$('#voiceVolVal').textContent=voiceVol.toFixed(2);localStorage.setItem('voiceVol',String(voiceVol));});
    $('#voiceTest').addEventListener('click',()=>speakJa('„ÅÇ „ÅÑ „ÅÜ „Åà „Åä'));

    // BGM controls
    $('#bgmVol').value=bgmVol.toFixed(2); $('#bgmVolVal').textContent=bgmVol.toFixed(2);
    $('#bgmVol').addEventListener('input',e=>{bgmVol=parseFloat(e.target.value);$('#bgmVolVal').textContent=bgmVol.toFixed(2);bgm.volume=bgmVol;localStorage.setItem('bgmVol',String(bgmVol));});
    $('#bgmToggle').addEventListener('click',()=>setBgmOn(!bgmOn));
    $('#bgmFile').addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;const url=URL.createObjectURL(f);bgm.src=url;setBgmOn(true);});

    function rebuildRowsUI(){
      const box=$('#rowList'); box.innerHTML='';
      ROWS.forEach(r=>{
        const id='row-'+r.key;
        const label=document.createElement('label');
        label.className='flex items-center gap-2 bg-white/70 backdrop-blur rounded-lg px-2 py-2 border border-white';
        label.innerHTML=`<input class="accent-black" type="checkbox" id="${id}" ${enabledRows.has(r.key)?'checked':''}/> <span>${r.label}</span>`;
        box.appendChild(label);
        $('#'+id).addEventListener('change',e=>{
          if(e.target.checked) enabledRows.add(r.key); else enabledRows.delete(r.key);
          if(enabledRows.size===0){enabledRows.add(r.key); e.target.checked=true;}
          persistRows(); rebuildPool(); newQuestion();
        });
      });
    }
    function rebuildPool(){ pool=KANA.filter(k=>enabledRows.has(k.row)); }
    function persistRows(){ localStorage.setItem('enabledRows',JSON.stringify(Array.from(enabledRows))); }
    function persist(){ localStorage.setItem('score',String(score)); localStorage.setItem('total',String(total)); localStorage.setItem('streak',String(streak)); localStorage.setItem('history',JSON.stringify(history)); }

    function render(){
      const q=$('#qwrap'); q.innerHTML='';
      if(mode==='multiple'){
        q.innerHTML=`
          <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Æ‡∏¥‡∏£‡∏≤‡∏á‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏°‡∏≤‡∏à‡∏¥</div>
          <div class="mt-3 flex items-center gap-3">
            <div id="prompt" class="text-6xl sm:text-7xl font-bold tracking-wide"></div>
            <button id="qSpeak" class="btn" title="‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÇ‡∏£‡∏°‡∏≤‡∏à‡∏¥">üîä</button>
          </div>
          <div id="opts" class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-3 w-full"></div>
          <div class="mt-3"><button id="revealBtn" class="btn-primary">‡πÄ‡∏â‡∏•‡∏¢</button></div>`;
        $('#qSpeak').addEventListener('click',()=>speakJa(question?.romaji?.[0]||'')); paintMultiple();
        $('#revealBtn').addEventListener('click',()=>{ if(!reveal){reveal=true;paintChoices();} else {newQuestion();} });
      } else if(mode==='typing'){
        q.innerHTML=`
          <div class="text-sm text-gray-500">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏£‡∏°‡∏≤‡∏à‡∏¥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Æ‡∏¥‡∏£‡∏≤‡∏á‡∏≤‡∏ô‡∏∞</div>
          <div class="mt-3 flex items-center gap-3">
            <div id="prompt" class="text-7xl font-bold"></div>
            <button id="qSpeak" class="btn" title="‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Æ‡∏¥‡∏£‡∏≤‡∏á‡∏≤‡∏ô‡∏∞">üîä</button>
          </div>
          <form id="form" class="mt-4 flex w-full max-w-sm gap-2">
            <input id="ans" class="flex-1 rounded-xl border border-gray-300 px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-black"
                   placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πà‡∏ô shi, chi, tsu („Çì: n/nn/n')" autocomplete="off"/>
            <button class="btn-primary">${reveal ? '‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ' : '‡∏ï‡∏£‡∏ß‡∏à'}</button>
          </form>
          <div id="solution" class="mt-3 text-center hidden">
            <div class="text-sm">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</div>
            <div id="solText" class="text-2xl font-semibold"></div>
          </div>`;
        $('#qSpeak').addEventListener('click',()=>speakJa(question?.kana||'')); $('#form').addEventListener('submit',e=>{e.preventDefault(); if(!reveal) submitTyping(); else newQuestion();});
        $('#ans').focus(); $('#prompt').textContent=question?.kana||'';
      } else {
        q.innerHTML=`
          <div class="text-sm text-gray-500">Flashcard: ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏¥‡∏Å</div>
          <button id="card" class="mt-3 w-64 h-40 sm:w-80 sm:h-48 rounded-2xl bg-white/70 backdrop-blur border border-white flex items-center justify-center text-6xl"></button>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="shuffleBtn" class="btn">‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            <button id="nextBtn" class="btn-primary">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            <button id="qSpeak" class="btn" title="‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏≠‡∏¢‡∏π‡πà">üîä</button>
          </div>`;
        const card=$('#card'); const paint=()=>card.textContent=reveal?(question?.romaji?.[0]||''):(question?.kana||'');
        card.addEventListener('click',()=>{reveal=!reveal; paint();});
        $('#shuffleBtn').addEventListener('click',()=>{reveal=false; newQuestion();});
        $('#nextBtn').addEventListener('click',()=>{reveal=false; newQuestion();});
        $('#qSpeak').addEventListener('click',()=>speakJa(reveal?(question?.romaji?.[0]||''):(question?.kana||'')));
        paint();
      }
      $('#speakBtn').onclick=()=>{ if(mode==='multiple') speakJa(question?.romaji?.[0]||''); else speakJa(question?.kana||''); };
    }

    function paintMultiple(){
      $('#prompt').textContent=question?.romaji?.[0]||'';
      const opts=$('#opts'); opts.innerHTML='';
      choices.forEach(c=>{
        const b=document.createElement('button');
        b.className='text-4xl bg-white/80 backdrop-blur rounded-2xl py-4 transition border border-white hover:bg-white disabled:opacity-75';
        b.textContent=c.kana; b.onclick=()=>choose(c); opts.appendChild(b);
      });
      paintChoices();
    }
    function paintChoices(){
      const btns=$$('#opts > button');
      btns.forEach((b,i)=>{
        const c=choices[i]; b.disabled=reveal;
        b.classList.remove('bg-green-50','border-green-500','bg-red-50','border-red-500');
        if(reveal){
          if(c.kana===question.kana) b.classList.add('bg-green-50','border-green-500');
          else if(history[0]?.a===c.kana && !history[0]?.ok) b.classList.add('bg-red-50','border-red-500');
        }
      });
      $('#revealBtn').textContent=reveal?'‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚Üí':'‡πÄ‡∏â‡∏•‡∏¢';
    }

    // Logic
    function newQuestion(){
      question=pick(pool); reveal=false;
      if(mode==='multiple'){
        const wrongs=shuffle(pool.filter(k=>k.kana!==question.kana)).slice(0,3);
        choices=shuffle([question,...wrongs]);
      }
      render();
      if($('#autoplay').checked){ if(mode==='multiple') speakJa(question?.romaji?.[0]||''); else speakJa(question?.kana||''); }
    }
    function submitTyping(){
      const input=$('#ans').value||''; const ok=isCorrect(input,question);
      total++; if(ok) score++; streak=ok?(streak+1):0;
      history.unshift({ q:question.kana, a:input||'(‡∏ß‡πà‡∏≤‡∏á)', correct:question.romaji[0], ok });
      history=history.slice(0,20);
      persist(); updateMetrics(); renderHistory();
      reveal=true; $('#solText').textContent=question.romaji.join(' / '); $('#solution').classList.remove('hidden'); $('#form button').textContent='‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ';
    }
    function choose(c){
      const ok=c.kana===question.kana;
      total++; if(ok) score++; streak=ok?(streak+1):0;
      history.unshift({ q:question.romaji[0], a:c.kana, correct:question.kana, ok });
      history=history.slice(0,20);
      persist(); updateMetrics(); renderHistory();
      reveal=true; paintChoices();
    }

    function updateMetrics(){ const acc= total? Math.round((score/total)*100):0; $('#score').textContent=`${score}/${total}`; $('#acc').textContent=`${acc}%`; $('#streak').textContent=`${streak}`; }
    function renderHistory(){
      const ul=$('#history'); ul.innerHTML='';
      if(!history.length){ ul.innerHTML='<li class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>'; return; }
      history.forEach(h=>{
        const li=document.createElement('li');
        li.className=`flex justify-between rounded-lg px-2 py-1 ${h.ok?'bg-green-50':'bg-red-50'}`;
        li.innerHTML=`<span class="font-medium">${h.q}</span><span class="opacity-70">‚Üí ${h.a}</span><span class="font-medium">‚úì ${h.correct}</span>`;
        ul.appendChild(li);
      });
    }

    // Tests
    function runTests(){
      const cases=[
        {name:'normalize: trim+lower',fn:'n',input:'  Shi  ',expect:'shi'},
        {name:'normalize: spaces',fn:'n',input:' t su ',expect:'tsu'},
        {name:"normalize: n'",fn:'n',input:" N' ",expect:"n'"},
        {name:'„Åó -> shi',fn:'c',kana:'„Åó',input:'shi',expect:true},
        {name:'„Åó -> si',fn:'c',kana:'„Åó',input:'si',expect:true},
        {name:'„Å° -> chi',fn:'c',kana:'„Å°',input:'chi',expect:true},
        {name:'„Å° -> ti',fn:'c',kana:'„Å°',input:'ti',expect:true},
        {name:'„Å§ -> tsu',fn:'c',kana:'„Å§',input:'tsu',expect:true},
        {name:'„Å§ -> tu',fn:'c',kana:'„Å§',input:'tu',expect:true},
        {name:'„Çí -> wo',fn:'c',kana:'„Çí',input:'wo',expect:true},
        {name:'„Çí -> o',fn:'c',kana:'„Çí',input:'o',expect:true},
        {name:'„Çà -> Yo',fn:'c',kana:'„Çà',input:'Yo',expect:true},
        {name:"„Çì -> n",fn:'c',kana:'„Çì',input:'n',expect:true},
        {name:"„Çì -> nn",fn:'c',kana:'„Çì',input:'nn',expect:true},
        {name:"„Çì -> n'",fn:'c',kana:'„Çì',input:"n'",expect:true},
        {name:'blank ‚â† „Åã',fn:'c',kana:'„Åã',input:'',expect:false},
        {name:"'na' ‚â† „Çì",fn:'c',kana:'„Çì',input:'na',expect:false},
      ];
      const find=(k)=>KANA.find(x=>x.kana===k);
      const results=cases.map(t=>({ ...t, ok: t.fn==='n'? norm(t.input)===t.expect : isCorrect(t.input,find(t.kana))===t.expect }));
      const passed=results.filter(r=>r.ok).length;
      $('#tstatus').textContent=`(${passed}/${results.length} passed)`;
      $('#tlabel').textContent= passed===results.length ? 'All good ‚úÖ' : 'Some tests failed ‚ùå';
      const ul=$('#tresults'); ul.innerHTML='';
      results.forEach(r=>{
        const li=document.createElement('li');
        li.className=`rounded px-2 py-1 ${r.ok?'bg-green-50':'bg-red-50'}`; li.textContent=`${r.ok?'‚úÖ':'‚ùå'} ${r.name}`;
        ul.appendChild(li);
      });
    }
    $('#runTests').addEventListener('click',runTests);

    // Init
    $('#autoplay').checked=localStorage.getItem('autoplay')==='true';
    $('#autoplay').addEventListener('change',e=>localStorage.setItem('autoplay',String(e.target.checked)));
    rebuildRowsUI(); updateMetrics(); renderHistory(); render(); newQuestion();
    $('#bgmToggle').textContent=bgmOn?'üéµ BGM: On':'üéµ BGM: Off'; if(bgmOn) setBgmOn(true);
  </script>
</body>
</html>
