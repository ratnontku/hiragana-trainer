<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hiragana Trainer (Single File)</title>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --fg:#111; --muted:#666; --border:#e5e7eb; --green:#16a34a22; --red:#dc262622; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--fg); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; min-height: 100vh; display:flex; align-items: center; justify-content: center; }
    .app { width: 100%; max-width: 1000px; }
    header { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; justify-content: space-between; margin-bottom: 16px; }
    h1 { font-size: 28px; margin:0; font-weight: 800; }
    .metrics { display:flex; gap:8px; align-items:center; }
    .metric { background:var(--card); padding:10px 12px; border-radius:12px; box-shadow: 0 1px 2px rgba(0,0,0,.05); text-align:right; }
    .metric .label { font-size:12px; color:var(--muted); }
    .metric .value { font-weight:700; }
    .btn { border:1px solid var(--border); padding:8px 12px; border-radius:12px; background:#eee; cursor:pointer; font-size: 14px; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .grid { display:grid; grid-template-columns: 1fr 280px; gap:16px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
    .card { background:var(--card); border-radius:16px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
    .tabs { display:flex; gap:8px; }
    .tab { border:1px solid var(--border); padding:8px 12px; border-radius:16px; background:#fff; cursor:pointer; font-size:14px; }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    .center { display:flex; flex-direction:column; align-items:center; }
    .prompt { color:var(--muted); font-size: 14px; }
    .q-big { margin-top:8px; font-size: clamp(42px, 12vw, 72px); font-weight:800; letter-spacing: .02em; }
    .choices { margin-top:16px; display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; width:100%; }
    @media (max-width:640px){ .choices { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .choice { font-size:38px; padding:16px 0; background:#f3f4f6; border-radius:16px; border:1px solid transparent; cursor:pointer; }
    .choice.correct { background:#ecfdf5; border-color:#16a34a; }
    .choice.wrong { background:#fef2f2; border-color:#dc2626; }
    .row-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; }
    .row-item { background:#f9fafb; border-radius:8px; padding:6px 8px; display:flex; gap:8px; align-items:center; font-size: 14px; }
    .history { margin-top:12px; max-height: 260px; overflow:auto; padding-right:6px; }
    .history li { display:flex; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:8px; font-size:14px; }
    .history li.ok { background: var(--green); }
    .history li.ng { background: var(--red); }
    .muted { color:var(--muted); }
    .stack { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    details summary { cursor:pointer; }
    footer { text-align:center; color:#666; font-size:12px; margin-top:12px; }
    input[type="text"] { padding:12px 14px; border:1px solid var(--border); border-radius:12px; font-size:16px; outline:none; width:100%; }
    input[type="text"]:focus { box-shadow: 0 0 0 2px #1113; }
  </style>
</head>
<body>
  <div class="container">
    <div class="app">
      <header>
        <h1>ひらがな Hiragana Trainer</h1>
        <div class="metrics">
          <div class="metric"><div class="label">คะแนน</div><div class="value" id="m-score">0/0</div><div class="label" id="m-acc">0%</div></div>
          <div class="metric"><div class="label">สตรีค</div><div class="value" id="m-streak">0</div></div>
          <button class="btn" id="btn-reset">รีเซ็ต</button>
        </div>
      </header>

      <div class="grid">
        <section class="card">
          <div class="tabs">
            <button class="tab active" data-mode="multiple">ตัวเลือก</button>
            <button class="tab" data-mode="typing">พิมพ์คำตอบ</button>
            <button class="tab" data-mode="cards">Flashcards</button>
          </div>

          <div class="center" id="game-area">
            <!-- dynamic content inserted by JS -->
          </div>
        </section>

        <aside class="card">
          <div class="stack" style="justify-content:space-between">
            <div class="label" style="font-weight:600">ช่วงตัวอักษร (เลือกได้หลายอัน)</div>
            <div class="stack">
              <button class="btn" id="btn-all">เลือกทั้งหมด</button>
              <button class="btn" id="btn-easy">เริ่มง่าย (あ~さ)</button>
            </div>
          </div>
          <div class="row-grid" id="row-grid"></div>

          <div style="margin-top:16px">
            <div class="label" style="font-weight:600; margin-bottom:6px">ประวัติล่าสุด</div>
            <ul class="history" id="history"></ul>
          </div>

          <details style="margin-top:16px">
            <summary class="label" style="font-weight:600">Self-tests <span id="tests-status" class="muted">(not run)</span></summary>
            <div class="stack" style="margin-top:8px">
              <button class="btn" id="btn-tests">Run tests</button>
              <span class="muted" id="tests-msg"></span>
            </div>
            <ul class="history" id="tests-list" style="max-height:200px"></ul>
          </details>
        </aside>
      </div>

      <footer>
        เคล็ดลับ: し = shi/si, ち = chi/ti, つ = tsu/tu, ふ = fu/hu, を = wo/o, ん = n/nn/n'
      </footer>
    </div>
  </div>

  <script>
    // --- Data ---
    const KANA = [
      { kana: 'あ', romaji: ['a'], row: 'a' },
      { kana: 'い', romaji: ['i'], row: 'a' },
      { kana: 'う', romaji: ['u'], row: 'a' },
      { kana: 'え', romaji: ['e'], row: 'a' },
      { kana: 'お', romaji: ['o'], row: 'a' },
      { kana: 'か', romaji: ['ka'], row: 'ka' },
      { kana: 'き', romaji: ['ki'], row: 'ka' },
      { kana: 'く', romaji: ['ku'], row: 'ka' },
      { kana: 'け', romaji: ['ke'], row: 'ka' },
      { kana: 'こ', romaji: ['ko'], row: 'ka' },
      { kana: 'さ', romaji: ['sa'], row: 'sa' },
      { kana: 'し', romaji: ['shi','si'], row: 'sa' },
      { kana: 'す', romaji: ['su'], row: 'sa' },
      { kana: 'せ', romaji: ['se'], row: 'sa' },
      { kana: 'そ', romaji: ['so'], row: 'sa' },
      { kana: 'た', romaji: ['ta'], row: 'ta' },
      { kana: 'ち', romaji: ['chi','ti'], row: 'ta' },
      { kana: 'つ', romaji: ['tsu','tu'], row: 'ta' },
      { kana: 'て', romaji: ['te'], row: 'ta' },
      { kana: 'と', romaji: ['to'], row: 'ta' },
      { kana: 'な', romaji: ['na'], row: 'na' },
      { kana: 'に', romaji: ['ni'], row: 'na' },
      { kana: 'ぬ', romaji: ['nu'], row: 'na' },
      { kana: 'ね', romaji: ['ne'], row: 'na' },
      { kana: 'の', romaji: ['no'], row: 'na' },
      { kana: 'は', romaji: ['ha'], row: 'ha' },
      { kana: 'ひ', romaji: ['hi'], row: 'ha' },
      { kana: 'ふ', romaji: ['fu','hu'], row: 'ha' },
      { kana: 'へ', romaji: ['he'], row: 'ha' },
      { kana: 'ほ', romaji: ['ho'], row: 'ha' },
      { kana: 'ま', romaji: ['ma'], row: 'ma' },
      { kana: 'み', romaji: ['mi'], row: 'ma' },
      { kana: 'む', romaji: ['mu'], row: 'ma' },
      { kana: 'め', romaji: ['me'], row: 'ma' },
      { kana: 'も', romaji: ['mo'], row: 'ma' },
      { kana: 'や', romaji: ['ya'], row: 'ya' },
      { kana: 'ゆ', romaji: ['yu'], row: 'ya' },
      { kana: 'よ', romaji: ['yo'], row: 'ya' },
      { kana: 'ら', romaji: ['ra'], row: 'ra' },
      { kana: 'り', romaji: ['ri'], row: 'ra' },
      { kana: 'る', romaji: ['ru'], row: 'ra' },
      { kana: 'れ', romaji: ['re'], row: 'ra' },
      { kana: 'ろ', romaji: ['ro'], row: 'ra' },
      { kana: 'わ', romaji: ['wa'], row: 'wa' },
      { kana: 'を', romaji: ['wo','o'], row: 'wa' },
      { kana: 'ん', romaji: ['n','nn','n\''], row: 'n' },
    ];

    const ROWS = [
      { key: 'a', label: 'あ(あ-อ)' },
      { key: 'ka', label: 'か(か-こ)' },
      { key: 'sa', label: 'さ(さ-そ)' },
      { key: 'ta', label: 'た(た-と)' },
      { key: 'na', label: 'な(な-の)' },
      { key: 'ha', label: 'は(は-ほ)' },
      { key: 'ma', label: 'ま(ま-も)' },
      { key: 'ya', label: 'や(や-よ)' },
      { key: 'ra', label: 'ら(ら-ろ)' },
      { key: 'wa', label: 'わ/を' },
      { key: 'n', label: 'ん' },
    ];

    // --- Helpers ---
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);

    function normalizeRomaji(s){ return (s ?? '').trim().toLowerCase().replace(/\s+/g,''); }
    function isRomajiCorrect(input, item){ const n=normalizeRomaji(input); return item.romaji.some(r=>normalizeRomaji(r)===n); }

    // --- State ---
    let mode = 'multiple';
    let enabledRows = new Set(ROWS.map(r=>r.key));
    let pool = KANA.filter(k=>enabledRows.has(k.row));
    let question = null;
    let choices = [];
    let reveal = false;
    let score = 0, total = 0, streak = 0;
    const history = [];

    // --- UI Wiring ---
    qsa('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qsa('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        mode = btn.dataset.mode;
        nextQuestion();
      });
    });

    qs('#btn-reset').addEventListener('click', ()=>{ score=0; total=0; streak=0; history.length=0; updateMetrics(); renderHistory(); nextQuestion(); });
    qs('#btn-all').addEventListener('click', ()=>{ enabledRows=new Set(ROWS.map(r=>r.key)); updateRowsUI(); refreshPool(); });
    qs('#btn-easy').addEventListener('click', ()=>{ enabledRows=new Set(['a','ka','sa']); updateRowsUI(); refreshPool(); });

    function updateRowsUI(){
      const grid = qs('#row-grid');
      grid.innerHTML = '';
      ROWS.forEach(r=>{
        const id = 'row-'+r.key;
        const item = document.createElement('label');
        item.className='row-item';
        item.innerHTML = `<input type="checkbox" id="${id}" ${enabledRows.has(r.key)?'checked':''}/> <span>${r.label}</span>`;
        const input = item.querySelector('input');
        input.addEventListener('change', ()=>{
          if (input.checked) enabledRows.add(r.key); else enabledRows.delete(r.key);
          if (enabledRows.size===0){ input.checked=true; enabledRows.add(r.key); }
          refreshPool();
        });
        grid.appendChild(item);
      });
    }

    function refreshPool(){ pool = KANA.filter(k=>enabledRows.has(k.row)); nextQuestion(); }

    function buildQuestion(base){
      if (mode==='multiple'){
        const correct = base;
        const wrongs = shuffle(pool.filter(k=>k.kana!==correct.kana)).slice(0,3);
        choices = shuffle([correct, ...wrongs]);
      }
      question = base; reveal=false; render();
    }

    function nextQuestion(){ if (!pool.length) refreshPool(); buildQuestion(pick(pool)); }

    function updateMetrics(){
      qs('#m-score').textContent = `${score}/${total}`;
      const acc = total? Math.round((score/total)*100) : 0;
      qs('#m-acc').textContent = `${acc}%`;
      qs('#m-streak').textContent = `${streak}`;
    }

    function pushHistory(entry){
      history.unshift(entry); if (history.length>20) history.pop(); renderHistory();
    }

    function renderHistory(){
      const ul = qs('#history');
      if (!history.length){ ul.innerHTML = '<li class="muted">ยังไม่มีประวัติ</li>'; return; }
      ul.innerHTML = history.map(h=>`<li class="${h.ok?'ok':'ng'}"><span><strong>${h.q}</strong></span><span class="muted">→ ${h.a}</span><span><strong>✓ ${h.correct}</strong></span></li>`).join('');
    }

    function handleChoose(c){
      if (!question) return;
      const ok = c.kana === question.kana;
      total += 1; if (ok) score += 1; streak = ok ? (streak+1) : 0;
      pushHistory({ q: question.romaji[0], a: c.kana, correct: question.kana, ok });
      reveal = true; render();
    }

    function handleTypingSubmit(input){
      const ok = isRomajiCorrect(input, question);
      total += 1; if (ok) score += 1; streak = ok ? (streak+1) : 0;
      pushHistory({ q: question.kana, a: input || '(ว่าง)', correct: question.romaji[0], ok });
      reveal = true; render();
    }

    function render(){
      updateMetrics();
      const area = qs('#game-area');
      if (!question){ area.innerHTML=''; return; }
      if (mode==='multiple'){
        area.innerHTML = `
          <div class="prompt">เลือกฮิรางานะให้ตรงกับโรมาจิ</div>
          <div class="q-big">${question.romaji[0]}</div>
          <div class="choices">${choices.map(c=>`<button class="choice" data-kana="${c.kana}">${c.kana}</button>`).join('')}</div>
          <div style="margin-top:10px"><button class="btn primary" id="btn-reveal-next">${reveal?'ข้อต่อไป →':'เฉลย'}</button></div>
        `;
        qsa('.choice', area).forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const kana = btn.dataset.kana; const c = choices.find(x=>x.kana===kana); handleChoose(c);
          });
        });
        const btnRN = qs('#btn-reveal-next', area);
        btnRN.addEventListener('click', ()=>{ if (!reveal) { reveal=true; render(); } else { nextQuestion(); } });
        if (reveal){
          qsa('.choice', area).forEach(btn=>{
            const kana = btn.dataset.kana;
            if (kana===question.kana) btn.classList.add('correct');
            const last = history[0];
            if (last && !last.ok && kana===last.a) btn.classList.add('wrong');
          });
        }
      } else if (mode==='typing'){
        area.innerHTML = `
          <div class="prompt">พิมพ์โรมาจิให้ตรงกับฮิรางานะ</div>
          <div class="q-big">${question.kana}</div>
          <form id="typing-form" class="stack" style="margin-top:10px; width:100%; max-width:420px">
            <input id="typing-input" type="text" placeholder="พิมพ์เช่น shi, chi, tsu (ん: n/nn/n')" ${reveal?'disabled':''} />
            <button class="btn primary" type="submit">${reveal?'ข้อต่อไป':'ตรวจ'}</button>
          </form>
          ${reveal?`<div class="muted" style="margin-top:6px">คำตอบที่ถูกต้อง: <strong>${question.romaji.join(' / ')}</strong></div>`:''}
        `;
        const form = qs('#typing-form', area);
        const input = qs('#typing-input', area);
        if (!reveal) input.focus();
        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          if (!reveal) handleTypingSubmit(input.value); else nextQuestion();
        });
      } else if (mode==='cards'){
        area.innerHTML = `
          <div class="prompt">Flashcard: แตะเพื่อพลิก</div>
          <button id="card" class="choice" style="width:320px; height:200px">${reveal?question.romaji[0]:question.kana}</button>
          <div class="stack" style="margin-top:10px">
            <button class="btn" id="btn-shuffle">สุ่มใหม่</button>
            <button class="btn primary" id="btn-next">ถัดไป →</button>
          </div>
        `;
        qs('#card', area).addEventListener('click', ()=>{ reveal=!reveal; render(); });
        qs('#btn-shuffle', area).addEventListener('click', ()=>{ reveal=false; nextQuestion(); });
        qs('#btn-next', area).addEventListener('click', ()=>{ reveal=false; nextQuestion(); });
      }
    }

    // --- Tests ---
    const tests = [
      { name: 'normalize: trim+lower', run: ()=> normalizeRomaji('  Shi  ')==='shi' },
      { name: 'normalize: spaces', run: ()=> normalizeRomaji(' t su ')==='tsu' },
      { name: "normalize: n'", run: ()=> normalizeRomaji(" N' ")==="n'" },
      { name: 'し -> shi', run: ()=> isRomajiCorrect('shi', KANA.find(k=>k.kana==='し'))===true },
      { name: 'し -> si', run: ()=> isRomajiCorrect('si', KANA.find(k=>k.kana==='し'))===true },
      { name: 'ち -> chi', run: ()=> isRomajiCorrect('chi', KANA.find(k=>k.kana==='ち'))===true },
      { name: 'ち -> ti', run: ()=> isRomajiCorrect('ti', KANA.find(k=>k.kana==='ち'))===true },
      { name: 'つ -> tsu', run: ()=> isRomajiCorrect('tsu', KANA.find(k=>k.kana==='つ'))===true },
      { name: 'つ -> tu', run: ()=> isRomajiCorrect('tu', KANA.find(k=>k.kana==='つ'))===true },
      { name: 'を -> wo', run: ()=> isRomajiCorrect('wo', KANA.find(k=>k.kana==='を'))===true },
      { name: 'を -> o', run: ()=> isRomajiCorrect('o', KANA.find(k=>k.kana==='を'))===true },
      { name: 'よ -> Yo (case-insensitive)', run: ()=> isRomajiCorrect('Yo', KANA.find(k=>k.kana==='よ'))===true },
      { name: 'blank ≠ か', run: ()=> isRomajiCorrect('', KANA.find(k=>k.kana==='か'))===false },
      { name: 'ん -> n', run: ()=> isRomajiCorrect('n', KANA.find(k=>k.kana==='ん'))===true },
      { name: "ん -> nn", run: ()=> isRomajiCorrect('nn', KANA.find(k=>k.kana==='ん'))===true },
      { name: "ん -> n'", run: ()=> isRomajiCorrect("n'", KANA.find(k=>k.kana==='ん'))===true },
      { name: "'na' ≠ ん", run: ()=> isRomajiCorrect('na', KANA.find(k=>k.kana==='ん'))===false },
    ];

    qs('#btn-tests').addEventListener('click', ()=>{
      const results = tests.map(t=>({ name:t.name, ok:t.run() }));
      const passed = results.filter(r=>r.ok).length;
      qs('#tests-status').textContent = `(${passed}/${results.length} passed)`;
      qs('#tests-msg').textContent = passed===results.length ? 'All good ✅' : 'Some tests failed ❌';
      qs('#tests-list').innerHTML = results.map(r=>`<li class="${r.ok?'ok':'ng'}">${r.ok?'✅':'❌'} ${r.name}</li>`).join('');
    });

    // --- Init ---
    updateRowsUI();
    refreshPool();
  </script>
</body>
</html>
